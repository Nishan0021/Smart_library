<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Smart Library - Admin Dashboard</title>

<style>
* { box-sizing: border-box; font-family: Arial, sans-serif; }
body { margin: 0; padding: 0; background: #f4f6fb; }

.container {
  max-width: 1000px;
  margin: 30px auto;
  background: #fff;
  padding: 20px 25px 30px;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

h1 { text-align: center; margin-bottom: 5px; }
.subtitle {
  text-align: center;
  font-size: 14px;
  color: #555;
  margin-bottom: 15px;
}

.top-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
  font-size: 14px;
}

.badge {
  padding: 4px 8px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 600;
  background: #e8f0fe;
  color: #1a3fb2;
  border: 1px solid #9bb3ff;
}

.btn {
  border: none;
  border-radius: 5px;
  padding: 8px 14px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
}

.btn-primary { background: #4c6fff; color: #fff; }
.btn-primary:hover { background: #3b57d9; }

.btn-danger { background: #ff4c4c; color: #fff; }
.btn-danger:hover { background: #e04343; }

.btn-secondary { background: #ffb020; color: #fff; }
.btn-secondary:hover { background: #e09c1c; }

.small { font-size: 12px; color: #555; }

.form-row {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 10px;
}

.form-group {
  flex: 1;
  min-width: 150px;
  display: flex;
  flex-direction: column;
  font-size: 14px;
}

label { font-weight: 600; margin-bottom: 2px; }

input {
  padding: 6px 8px;
  border-radius: 5px;
  border: 1px solid #ccc;
  font-size: 14px;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
  font-size: 13px;
  background: #fff;
  border-radius: 8px;
  overflow: hidden;
}

th, td {
  border-bottom: 1px solid #eee;
  padding: 8px 6px;
  text-align: left;
}

th {
  background: #f0f3ff;
  font-weight: 700;
}

tr:nth-child(even) { background: #fafbff; }

.status-available { color: #1a7f37; font-weight: 700; }
.status-issued { color: #b3261e; font-weight: 700; }

.admin-list {
  margin-top: 8px;
  padding-left: 16px;
  font-size: 13px;
}
</style>
</head>

<body>
<div class="container">

<h1>Smart Library - Admin Dashboard</h1>
<div class="subtitle">
Admin can Add / Issue / Return / Delete books.<br>
Only Main Admin can add more admin users.
</div>

<div class="top-bar">
<span id="roleBadge" class="badge"></span>
<div>
<button class="btn btn-primary" onclick="goStudent()">Student View</button>
<button class="btn btn-danger" onclick="logout()">Logout</button>
</div>
</div>

<!-- ================= BOOK MANAGEMENT ================= -->

<h3>Add New Book</h3>
<div class="form-row">
<div class="form-group">
<label>Book ID</label>
<input id="bookId">
</div>
<div class="form-group">
<label>Title</label>
<input id="bookTitle">
</div>
<div class="form-group">
<label>Author</label>
<input id="bookAuthor">
</div>
<div class="form-group">
<label>Year</label>
<input id="bookYear">
</div>
</div>

<button class="btn btn-primary" onclick="addBook()">Add Book</button>

<h3>Books List</h3>
<table>
<thead>
<tr>
<th>ID</th><th>Title</th><th>Author</th><th>Year</th>
<th>Status</th><th>Student</th><th>USN</th><th>Actions</th>
</tr>
</thead>
<tbody id="booksBody"></tbody>
</table>

<!-- ================= MAIN ADMIN SECTION ================= -->

<div id="adminSection">
<hr style="margin:25px 0 15px;">

<h3>Main Admin â€“ Manage Admin Users</h3>
<div class="small">
Only Main Admin can add additional admin users.
</div>

<div class="form-row">
<div class="form-group">
<label>New Admin User ID</label>
<input id="newAdminUser" placeholder="e.g. librarian01">
</div>
<div class="form-group">
<label>New Admin Password</label>
<input id="newAdminPass" type="password">
</div>
</div>

<button class="btn btn-primary" onclick="addAdminUser()">Add Admin User</button>
<div id="adminMsg" class="small"></div>

<div class="small" style="margin-top:10px;"><b>Existing Admins:</b></div>
<ul id="adminList" class="admin-list"></ul>
</div>

</div>

<!-- ================= SCRIPT ================= -->
<script type="module">
import { db } from "./firebase.js";
import {
  collection, addDoc, getDocs,
  updateDoc, deleteDoc, doc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ---------- SESSION ---------- */
const SESSION_KEY = "smartLibraryLoggedAdmin";
const ADMIN_KEY = "smartLibraryAdmins";
let loggedInAdmin = null;

function loadSession() {
  const data = localStorage.getItem(SESSION_KEY);
  if (!data) {
    alert("Please login first.");
    location.href = "admin-login.html";
    return;
  }
  loggedInAdmin = JSON.parse(data);
  roleBadge.textContent =
    loggedInAdmin.role === "main" ? "MAIN ADMIN" : "ADMIN";

  if (loggedInAdmin.role !== "main") {
    document.getElementById("adminSection").style.display = "none";
  }
}

/* ---------- BOOKS (FIREBASE) ---------- */
let books = [];

async function loadBooks() {
  books = [];
  const snap = await getDocs(collection(db, "books"));
  snap.forEach(d => books.push({ docId: d.id, ...d.data() }));
  renderBooks();
}

function renderBooks() {
  booksBody.innerHTML = "";
  books.forEach((b, i) => {
    booksBody.innerHTML += `
    <tr>
      <td>${b.id}</td>
      <td>${b.title}</td>
      <td>${b.author}</td>
      <td>${b.year}</td>
      <td class="${b.isIssued ? "status-issued" : "status-available"}">
        ${b.isIssued ? "Issued" : "Available"}
      </td>
      <td>${b.studentName || "-"}</td>
      <td>${b.studentUsn || "-"}</td>
      <td>
        <button class="btn btn-secondary" onclick="issue(${i})">Issue</button>
        <button class="btn btn-primary" onclick="ret(${i})">Return</button>
        <button class="btn btn-danger" onclick="del(${i})">Delete</button>
      </td>
    </tr>`;
  });
}

window.addBook = async () => {
  await addDoc(collection(db, "books"), {
    id: bookId.value,
    title: bookTitle.value,
    author: bookAuthor.value,
    year: bookYear.value,
    isIssued: false,
    studentName: "",
    studentUsn: ""
  });
  loadBooks();
};

window.issue = async i => {
  const n = prompt("Student Name:");
  const u = prompt("Student USN:");
  if (!n || !u) return;
  await updateDoc(doc(db, "books", books[i].docId), {
    isIssued: true, studentName: n, studentUsn: u
  });
  loadBooks();
};

window.ret = async i => {
  await updateDoc(doc(db, "books", books[i].docId), {
    isIssued: false, studentName: "", studentUsn: ""
  });
  loadBooks();
};

window.del = async i => {
  if (confirm("Delete this book?")) {
    await deleteDoc(doc(db, "books", books[i].docId));
    loadBooks();
  }
};

/* ---------- ADMIN USERS (LOCAL STORAGE) ---------- */
let admins = [];

function loadAdmins() {
  const data = localStorage.getItem(ADMIN_KEY);
  if (!data) {
    admins = [{ username: "admin", password: "admin123", role: "main" }];
    localStorage.setItem(ADMIN_KEY, JSON.stringify(admins));
  } else {
    admins = JSON.parse(data);
  }
  renderAdmins();
}

function renderAdmins() {
  adminList.innerHTML = "";
  admins.forEach(a => {
    const li = document.createElement("li");
    li.textContent = `${a.username} (${a.role})`;
    adminList.appendChild(li);
  });
}

window.addAdminUser = () => {
  const user = newAdminUser.value.trim();
  const pass = newAdminPass.value.trim();
  adminMsg.textContent = "";

  if (!user || !pass) {
    adminMsg.textContent = "User ID and Password required.";
    return;
  }

  if (admins.some(a => a.username === user)) {
    adminMsg.textContent = "Admin already exists.";
    return;
  }

  admins.push({ username: user, password: pass, role: "admin" });
  localStorage.setItem(ADMIN_KEY, JSON.stringify(admins));
  renderAdmins();

  adminMsg.textContent = "Admin added successfully.";
  newAdminUser.value = "";
  newAdminPass.value = "";
};

/* ---------- NAV ---------- */
window.goStudent = () => location.href = "index.html";
window.logout = () => {
  localStorage.removeItem(SESSION_KEY);
  location.href = "admin-login.html";
};

/* ---------- INIT ---------- */
loadSession();
loadBooks();
loadAdmins();
</script>

</body>
</html>
